<!DOCTYPE html>
<html lang="en"><head><script src="/TIL_notes/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=TIL_notes/livereload" data-no-instant defer></script>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="A catalogue of notable things I have learnt">
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.2/css/bulma.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="shortcut icon" href="http://localhost:1313/TIL_notes/favicon.ico">
    
    <link rel="stylesheet" href="/TIL_notes/css/style.min.css">

    <link rel="canonical" href="http://localhost:1313/TIL_notes/2024-11-18-django-s-transaction-atomic-context-manager-can-prevent-multiple-nested-atomic-blocks-from-being-committed-using-the-durable-flag/" />
    <title>Django&#39;s transaction.atomic context manager can prevent multiple/nested atomic blocks from being committed using the durable flag</title>
</head>
<body>
        <div id="wrapper"><section class="hero is-medium is-link">
    <div class="hero-body">
        <div class="container has-text-centered">
            <h1 class="title">
                <i class="fas fa-laptop-code"></i> Benji
            </h1>
            <h2 class="subtitle">
                Lead Senior Software Engineer <a class="has-text-white is-underlined has-text-weight-bold" href="https://www.aveni.ai/" target="_blank">@Aveni.ai</a>
            </h2>
        </div>
    </div>
</section>

<article>
    <header id="post-header">
        <h1>Django&#39;s transaction.atomic context manager can prevent multiple/nested atomic blocks from being committed using the durable flag</h1>
        <div>
                <time>November 18, 2024</time>
            </div>
    </header><p>Django&rsquo;s <code>atomic()</code> context manager can ensure a transaction block is always the outermost transaction using the <code>durable=True</code> flag. This prevents accidental nesting and guarantees database changes are actually committed to disk.</p>
<p><strong>The problem:</strong></p>
<p>Normally, nested <code>atomic()</code> blocks create savepoints rather than full transactions:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#a6e22e">@transaction.atomic</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">outer_function</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># This is a transaction</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">with</span> transaction<span style="color:#f92672">.</span>atomic():
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># This is just a savepoint, not a new transaction</span>
</span></span><span style="display:flex;"><span>        User<span style="color:#f92672">.</span>objects<span style="color:#f92672">.</span>create(name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;John&#34;</span>)
</span></span></code></pre></div><p><strong>The solution with <code>durable=True</code>:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> django.db <span style="color:#f92672">import</span> transaction
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># This ensures the block is never nested</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@transaction.atomic</span>(durable<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">create_user</span>(request):
</span></span><span style="display:flex;"><span>    user <span style="color:#f92672">=</span> User<span style="color:#f92672">.</span>objects<span style="color:#f92672">.</span>create(name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;John&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> user
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># This raises RuntimeError - can&#39;t nest durable block</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@transaction.atomic</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">process_request</span>(request):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">with</span> transaction<span style="color:#f92672">.</span>atomic(durable<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>):  <span style="color:#75715e"># ❌ RuntimeError!</span>
</span></span><span style="display:flex;"><span>        create_user(request)
</span></span></code></pre></div><p><strong>When to use it:</strong></p>
<p>The <code>durable</code> flag is useful when you need to guarantee:</p>
<ul>
<li>Database changes are actually committed to disk (not deferred as part of a larger transaction)</li>
<li>You want to prevent accidental nesting that could undermine durability guarantees</li>
<li>You&rsquo;re implementing critical operations that must be fully committed before proceeding (e.g., financial transactions, audit logs)</li>
</ul>
<p>If a durable block is nested, Django immediately raises a <code>RuntimeError</code>, making it clear that the code structure violates your durability requirements.</p>
<p><a href="https://docs.djangoproject.com/en/dev/topics/db/transactions/#controlling-transactions-explicitly">Original source</a></p>
</article>

        </div><footer class="footer">
    <div class="content has-text-centered">
        <p>
            <strong>Benjamin Lo</strong><br>
            Lead Senior Software Engineer<br>
            <a href="https://github.com/benji011">github.com/benji011</a>
        </p>
        <p>
            © <span id="current-year"></span> Benjamin Lo. All rights reserved.
        </p>
    </div>
    <script>
        document.getElementById('current-year').textContent = new Date().getFullYear();
    </script>
</footer>
</body>
</html>
